
commonAnnotations:
  argocd.argoproj.io/sync-wave: "10"

replicaCount: 1

image:
  repository: triobank/ledger-service
  pullPolicy: IfNotPresent
  tag: "latest"

imagePullSecrets:
  - name: dockerhub-credentials

serviceAccount:
  create: true
  name: ""

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/path: "/actuator/prometheus"
  prometheus.io/port: "8082"

podSecurityContext: {}
  # fsGroup: 2000

securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000

service:
  type: ClusterIP
  port: 8082
  targetPort: 8082

ingress:
  enabled: false
  className: "nginx"
  annotations: {}
  hosts:
    - host: ledger-service.local
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls: []

resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 100m
    memory: 512Mi

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80


livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    port: 8082
  initialDelaySeconds: 60
  periodSeconds: 10 

readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    port: 8082
  initialDelaySeconds: 30
  periodSeconds: 10

env:
  SPRING_PROFILES_ACTIVE: "prod"
  LOGGING_LEVEL_ROOT: "INFO"

# ConfigMap Environment Variables
config:
  APP_ENV: "prod"
  SERVER_PORT: "8082"
  # Kafka Configs
  KAFKA_BOOTSTRAP_SERVERS: "kafka-kafka-bootstrap.triobank.svc.cluster.local:9092"
  KAFKA_ENABLED: "true"
  # Database Connection String (Using Service Name from Helm)
  SPRING_DATASOURCE_URL: "jdbc:sqlserver://ledger-mssql.triobank.svc.cluster.local:1433;databaseName=ledger_db;encrypt=false;trustServerCertificate=true"

# Database Configuration (MSSQL)
databases:
  mssql:
    enabled: true
    serviceName: ledger-mssql
    type: mssql
    portName: mssql
    externalName: ""                 # Override in overlays (e.g., host.docker.internal)
    annotations:
      description: "Ledger primary transactional database"

database:
  name: ledger_db                    # Database name
  port: 1433                         # MSSQL port
  serviceName: ledger-mssql

# Migration Job
migration:
  enabled: true
  image: "akyurekridvan2101/ledger-migrate:latest"
  imagePullPolicy: "Always"
  imagePullSecrets:
    - name: dockerhub-credentials
  jdbcParams: "encrypt=false;trustServerCertificate=true"
  resources:
    limits:
      cpu: "200m"
      memory: "128Mi"
    requests:
      cpu: "50m"
      memory: "64Mi"


# Kafka & Debezium Configuration
kafka:
  bootstrapServers: "kafka-kafka-bootstrap.triobank:9092"

connector:
  enabled: true
  name: "ledger-cdc-connector"
  secretVolumeName: "ledger-db-credentials"
  
  database:
    hostname: "ledger-mssql.triobank"
    port: 1433
    names: "ledger_db"
    encrypt: "false"
    trustServerCertificate: "true"
  
  table:
    include: "dbo.outbox_events"
  
  topic:
    prefix: "ledger"
  
  snapshot:
    mode: "initial"
  
  outbox:
    routeByField: "aggregate_type"
    topicReplacement: "triobank.local.ledger.${routedByValue}.v1"
    fields:
      id: "id"
      key: "aggregate_id"
      type: "type"
      payload: "payload"
      timestamp: "created_at"
    tombstoneOnEmpty: "false"
    expandJsonPayload: "true"
  
  performance:
    pollInterval: "500"
    maxBatchSize: "2048"
  
  errors:
    tolerance: "all"
    logEnable: "true"
    logMessages: "true"
  
  heartbeat:
    interval: "60000"
    topicPrefix: "__debezium-heartbeat"
  
  tombstones: "true"

externalSecrets:
  - name: db-mssql
    enabled: true
    vaultPath: secret/dev/services/ledger
    targetSecret: ledger-db-credentials      # K8s Secret name
    refreshInterval: "1h"
    fields:
      - secretKey: username
        property: db_username
      - secretKey: password
        property: db_password
