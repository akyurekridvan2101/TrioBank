# API Gateway - Production Environment
# Vault kullanır (EC2'de çalışan Vault)

replicaCount: 1  # Production için high availability

image:
  tag: "latest"
  pullPolicy: Always  # Dev ile aynı - image değişikliklerinde güncel versiyonu çek

# Production environment config
config:
  APP_ENV: "production"
  API_GATEWAY_PORT: "3000"
  
  # Redis Configuration - Service name kullanılır (ExternalName service üzerinden)
  API_GATEWAY_REDIS_ADDRESS: "api-gateway-redis.triobank.svc.cluster.local:6379"
  API_GATEWAY_REDIS_CLIENT_NAME: "ApiGatewayRedis"
  
  # Microservice URLs (Kubernetes Internal DNS)
  AUTH_SERVICE_URL: "http://auth-service.triobank.svc.cluster.local:8080"
  CLIENT_SERVICE_URL: "http://client-service.triobank.svc.cluster.local:8082"
  ACCOUNT_SERVICE_URL: "http://account-service.triobank.svc.cluster.local:8081"
  TRANSACTION_SERVICE_URL: "http://transaction-service.triobank.svc.cluster.local:8084"
  LEDGER_SERVICE_URL: "http://ledger-service.triobank.svc.cluster.local:8082"
  CARD_SERVICE_URL: "http://card-service.triobank.svc.cluster.local:8083"
  MAIL_SERVICE_URL: "http://mail-service.triobank.svc.cluster.local:8081"

# Redis ExternalName Service - EC2 Private IP
# IP adresi Vault'ta secret/prod/services/api-gateway -> redis_address olarak saklanıyor
# Terraform output: terraform output ec2_private_ip
databases:
  redis:
    enabled: true
    serviceName: api-gateway-redis
    type: redis
    portName: redis
    externalName: "10.0.0.182"  # EC2 Private IP (Vault'ta: redis_address)
    annotations:
      description: "API Gateway Redis for rate limiting (Production - EC2)"

# Vault Secrets Configuration
externalSecrets:
  # Redis Credentials (API Gateway'e özel)
  - name: gateway-credentials
    enabled: true
    vaultPath: secret/prod/services/api-gateway  # Production path
    targetSecret: api-gateway-credentials
    refreshInterval: "1h"
    fields:
      - secretKey: API_GATEWAY_REDIS_PASSWORD
        property: redis_password  # Vault'ta: redis_password

# Production resources (artırıldı)
resources:
  requests:
    memory: 512Mi    # Production için artırıldı
    cpu: 200m       # Production için artırıldı
  limits:
    memory: 1Gi     # Production için artırıldı
    cpu: 1000m      # Production için artırıldı

# Ingress Configuration for Production
ingress:
  enabled: true
  className: alb  # AWS ALB
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
  hosts:
    - host: ""  # Vault'tan infrastructure/domain/api alınacak (sonra güncellenecek)
      paths:
        - path: /
          pathType: Prefix

